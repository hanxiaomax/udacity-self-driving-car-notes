<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>智能驾驶学习笔记 | 交通信号灯分类器</title>
    <meta name="description" content="by Lingfeng Ai">
    <link rel="icon" href="/udacity-self-driving-car-notes/logo.png">
  <link rel="manifest" href="/udacity-self-driving-car-notes/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/udacity-self-driving-car-notes/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/udacity-self-driving-car-notes/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/udacity-self-driving-car-notes/assets/css/40.styles.8bccc68c.css" as="style"><link rel="preload" href="/udacity-self-driving-car-notes/assets/js/app.f862d195.js" as="script"><link rel="preload" href="/udacity-self-driving-car-notes/assets/js/23.20d37bd2.js" as="script"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/0.a91770da.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/1.bf802ebd.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/2.9fcb0b63.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/3.04252e9b.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/4.58f7cc53.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/5.fbc900e9.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/6.eb545374.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/7.9389e4d4.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/8.ca6e42ad.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/9.951d4fff.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/10.6dceeebb.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/11.8b31e96d.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/12.47bd8573.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/13.01fa8388.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/14.5145a23d.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/15.a6c9c7ea.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/16.c8a59787.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/17.ef253f55.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/18.60236610.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/19.21a7c6ad.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/20.631b7e3b.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/21.4ea4e658.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/22.24b95f64.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/24.16e76604.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/25.ded15832.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/26.698b1477.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/27.dd2fff6b.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/28.60a3bb90.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/29.32a5d2dc.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/30.e686195c.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/31.182bda29.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/32.72fbf8ad.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/33.1b4a0149.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/34.12748df4.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/35.4a1138f6.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/36.9e421a98.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/37.803fd82e.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/38.0a53c283.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/39.aab83370.js">
    <link rel="stylesheet" href="/udacity-self-driving-car-notes/assets/css/40.styles.8bccc68c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/udacity-self-driving-car-notes/" class="home-link router-link-active"><!----><span class="site-name">
      智能驾驶学习笔记
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/udacity-self-driving-car-notes/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">笔记</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/" class="nav-link router-link-active">无人驾驶入门</a></li><li class="dropdown-item"><!----><a href="/udacity-self-driving-car-notes/posts/self-driving-car/" class="nav-link">无人驾驶工程师</a></li><li class="dropdown-item"><!----><a href="/udacity-self-driving-car-notes/posts/others/" class="nav-link">未归类</a></li></ul></div></div><div class="nav-item"><a href="/udacity-self-driving-car-notes/res/" class="nav-link">资源</a></div><div class="nav-item"><a href="/udacity-self-driving-car-notes/contact/" class="nav-link">联系</a></div><a href="https://github.com/hanxiaomax/udacity-self-driving-car-notes/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/udacity-self-driving-car-notes/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">笔记</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/" class="nav-link router-link-active">无人驾驶入门</a></li><li class="dropdown-item"><!----><a href="/udacity-self-driving-car-notes/posts/self-driving-car/" class="nav-link">无人驾驶工程师</a></li><li class="dropdown-item"><!----><a href="/udacity-self-driving-car-notes/posts/others/" class="nav-link">未归类</a></li></ul></div></div><div class="nav-item"><a href="/udacity-self-driving-car-notes/res/" class="nav-link">资源</a></div><div class="nav-item"><a href="/udacity-self-driving-car-notes/contact/" class="nav-link">联系</a></div><a href="https://github.com/hanxiaomax/udacity-self-driving-car-notes/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>1.统计基础与贝叶斯思维</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2.Python基础与面向对象</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>3.矩阵基础与卡尔曼滤波</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>4.C++基础与优化</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>5.数据结构与搜索算法</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>6.运动学与动力学</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>7.计算机视觉</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/isdc-traffic-light-classfier.html" class="active sidebar-link">交通信号灯分类器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/isdc-traffic-light-classfier.html#_1-加载并可视化数据" class="sidebar-link">1. 加载并可视化数据</a></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/isdc-traffic-light-classfier.html#_2-图像预处理" class="sidebar-link">2. 图像预处理</a></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/isdc-traffic-light-classfier.html#_3-特性提取" class="sidebar-link">3. 特性提取</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/isdc-traffic-light-classfier.html#_1-亮度特征" class="sidebar-link">1. 亮度特征</a></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/isdc-traffic-light-classfier.html#_2-颜色特征" class="sidebar-link">2. 颜色特征</a></li></ul></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/isdc-traffic-light-classfier.html#_4-图像分类并查看错误的情况" class="sidebar-link">4. 图像分类并查看错误的情况</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/isdc-traffic-light-classfier.html#_1-应用特征进行估计" class="sidebar-link">1. 应用特征进行估计</a></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/isdc-traffic-light-classfier.html#_2-图像分类并计算失误率" class="sidebar-link">2. 图像分类并计算失误率</a></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/isdc-traffic-light-classfier.html#_3-查看错误分类的图像" class="sidebar-link">3. 查看错误分类的图像</a></li></ul></li></ul></li></ul></div></li></ul></div><div class="page"><div class="content"><p>构建一个分类器需要经过如下几个步骤：</p><ol><li>加载并可视化数据</li><li>图像预处理</li><li>特性提取</li><li>图像分类并查看错误的情况</li></ol><h2 id="_1-加载并可视化数据"><a href="#_1-加载并可视化数据" aria-hidden="true" class="header-anchor">#</a> 1. 加载并可视化数据</h2><p>为了对图像集进行解析和处理，第一步当然是要了解我们的目标，首先获取一个感性的认识，然后分析其特点</p><p>我们首先从图像集里面过滤出三种颜色的信号灯，然后各取一张进行显示：</p><pre class="language-python"><code>red_images <span class="token operator">=</span> <span class="token punctuation">[</span>img <span class="token keyword">for</span> img <span class="token keyword">in</span> IMAGE_LIST <span class="token keyword">if</span> img<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'red'</span><span class="token punctuation">]</span>
yellow_images <span class="token operator">=</span> <span class="token punctuation">[</span>img <span class="token keyword">for</span> img <span class="token keyword">in</span> IMAGE_LIST <span class="token keyword">if</span> img<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'yellow'</span><span class="token punctuation">]</span>
green_images <span class="token operator">=</span> <span class="token punctuation">[</span>img <span class="token keyword">for</span> img <span class="token keyword">in</span> IMAGE_LIST <span class="token keyword">if</span> img<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'green'</span><span class="token punctuation">]</span>


f<span class="token punctuation">,</span><span class="token punctuation">(</span>ax1<span class="token punctuation">,</span>ax2<span class="token punctuation">,</span>ax3<span class="token punctuation">)</span> <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ax1<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>red_images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ax2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>yellow_images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ax3<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>green_images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ax1<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span>red_images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ax2<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span>yellow_images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ax3<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span>green_images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><p><img src="/udacity-self-driving-car-notes/assets/img/15219527815258.088def04.jpg" alt></p><h2 id="_2-图像预处理"><a href="#_2-图像预处理" aria-hidden="true" class="header-anchor">#</a> 2. 图像预处理</h2><p>通过观察，可以发现几点关键信息：[^1]</p><ol><li>图片尺寸不一致</li><li>图片光照条件不一致</li></ol><p>为此我们需要对图像进行预处理：</p><ol><li>标准化</li><li>one-hot 编码</li></ol><pre class="language-python"><code><span class="token comment">#标准化</span>
<span class="token keyword">def</span> <span class="token function">standardize_input</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    standard_im <span class="token operator">=</span> np<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    standard_im <span class="token operator">=</span> cv<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span>standard_im<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> standard_im
</code></pre><pre class="language-python"><code><span class="token comment">#one-hot 编码</span>
<span class="token keyword">def</span> <span class="token function">one_hot_encode</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>label<span class="token operator">==</span><span class="token string">'red'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        one_hot_encoded <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">elif</span><span class="token punctuation">(</span>label<span class="token operator">==</span><span class="token string">'yellow'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        one_hot_encoded <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">elif</span><span class="token punctuation">(</span>label<span class="token operator">==</span><span class="token string">'green'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        one_hot_encoded <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>    
    <span class="token keyword">return</span> one_hot_encoded
</code></pre><p>随后将图像集传入将所有图像进行标准化</p><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">standardize</span><span class="token punctuation">(</span>image_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
    standard_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> image_list<span class="token punctuation">:</span>
        image <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

        <span class="token comment">#标准化一幅图像</span>
        standardized_im <span class="token operator">=</span> standardize_input<span class="token punctuation">(</span>image<span class="token punctuation">)</span>

        <span class="token comment"># 编码</span>
        one_hot_label <span class="token operator">=</span> one_hot_encode<span class="token punctuation">(</span>label<span class="token punctuation">)</span>    

      standard_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>standardized_im<span class="token punctuation">,</span> one_hot_label<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
    <span class="token keyword">return</span> standard_list


STANDARDIZED_LIST <span class="token operator">=</span> standardize<span class="token punctuation">(</span>IMAGE_LIST<span class="token punctuation">)</span>
</code></pre><p>将<code>STANDARDIZED_LIST</code>中的结果选择其一打印出来</p><p><img src="/udacity-self-driving-car-notes/assets/img/15219553904482.ca2ed02d.jpg" alt></p><h2 id="_3-特性提取"><a href="#_3-特性提取" aria-hidden="true" class="header-anchor">#</a> 3. 特性提取</h2><p>抽取特征</p><ol><li>亮度特征</li><li>颜色特征</li><li>....</li></ol><h3 id="_1-亮度特征"><a href="#_1-亮度特征" aria-hidden="true" class="header-anchor">#</a> 1. 亮度特征</h3><p><img src="/udacity-self-driving-car-notes/assets/img/15219560942995.6610aca2.jpg" alt></p><p>首先我们将图像转换为 hsv 颜色空间</p><pre class="language-python"><code>image_num <span class="token operator">=</span> <span class="token number">0</span>
test_im <span class="token operator">=</span> STANDARDIZED_LIST<span class="token punctuation">[</span>image_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
test_label <span class="token operator">=</span> STANDARDIZED_LIST<span class="token punctuation">[</span>image_num<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

<span class="token comment"># Convert to HSV</span>
hsv <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>test_im<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_RGB2HSV<span class="token punctuation">)</span>

<span class="token comment"># Print image label</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Label [red, yellow, green]: '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>test_label<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># HSV channels</span>
h <span class="token operator">=</span> hsv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
s <span class="token operator">=</span> hsv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>
v <span class="token operator">=</span> hsv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>

f<span class="token punctuation">,</span> <span class="token punctuation">(</span>ax1<span class="token punctuation">,</span> ax2<span class="token punctuation">,</span> ax3<span class="token punctuation">,</span> ax4<span class="token punctuation">)</span> <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ax1<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Standardized image'</span><span class="token punctuation">)</span>
ax1<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>test_im<span class="token punctuation">)</span>
ax2<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'H channel'</span><span class="token punctuation">)</span>
ax2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>h<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span>
ax3<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'S channel'</span><span class="token punctuation">)</span>
ax3<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>s<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span>
ax4<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'V channel'</span><span class="token punctuation">)</span>
ax4<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>v<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span>

</code></pre><p><img src="/udacity-self-driving-car-notes/assets/img/15219564395258.367a79b4.jpg" alt>
由此可以看到，value 最能作为图像的特征，但是首先我们需要对图像进行预处理，这里的预处理指的是，我们需要对图像进行一些裁剪，保证信号灯部分占据主体。随后，将图像分割为上中下三部分，分别求对应部分像素value值的和，确定最亮的部分位于图像上中下哪个部分，以此作为信号灯判断的依据。</p><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">show_img_bright</span><span class="token punctuation">(</span>rgb<span class="token punctuation">,</span>hsv<span class="token punctuation">,</span>mask<span class="token punctuation">,</span>masked<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fig<span class="token punctuation">,</span><span class="token punctuation">(</span>ax1<span class="token punctuation">,</span>ax2<span class="token punctuation">,</span>ax3<span class="token punctuation">,</span>ax4<span class="token punctuation">)</span> <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ax1<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>rgb<span class="token punctuation">)</span>
    ax2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>hsv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span>
    ax3<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>mask<span class="token punctuation">,</span>cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span>
    ax4<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>masked<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span>
    

<span class="token keyword">def</span> <span class="token function">apply_bright_mask</span><span class="token punctuation">(</span>mask<span class="token punctuation">,</span>rgb_image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    masked_hsv_image <span class="token operator">=</span> np<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>rgb_image<span class="token punctuation">)</span>
    masked_hsv_image<span class="token punctuation">[</span>mask <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> masked_hsv_image

<span class="token keyword">def</span> <span class="token function">apply_resize</span><span class="token punctuation">(</span>rgb_image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    v <span class="token operator">=</span> <span class="token number">5</span>
    h <span class="token operator">=</span> <span class="token number">10</span>
    <span class="token keyword">return</span> rgb_image<span class="token punctuation">[</span>v<span class="token punctuation">:</span><span class="token operator">-</span>v<span class="token punctuation">,</span>h<span class="token punctuation">:</span><span class="token operator">-</span>h<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">calculate_brightness</span><span class="token punctuation">(</span>hsv_img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    height  <span class="token operator">=</span> hsv_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    width <span class="token operator">=</span> hsv_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    
    block_height <span class="token operator">=</span> height<span class="token operator">//</span><span class="token number">3</span>
    
    top_sum <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>hsv_img<span class="token punctuation">[</span><span class="token punctuation">:</span>block_height<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    mid_sum <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>hsv_img<span class="token punctuation">[</span>block_height<span class="token punctuation">:</span>block_height<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    bot_sum <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>hsv_img<span class="token punctuation">[</span>block_height<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">:</span>block_height<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>top_sum<span class="token punctuation">,</span>mid_sum<span class="token punctuation">,</span>bot_sum<span class="token punctuation">]</span>
    

<span class="token keyword">def</span> <span class="token function">create_feature_brightness</span><span class="token punctuation">(</span>rgb_image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    hsv_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>rgb_image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_RGB2HSV<span class="token punctuation">)</span>
    lower_hsv <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token number">210</span><span class="token punctuation">)</span> 
    upper_hsv <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
    mask<span class="token operator">=</span>cv2<span class="token punctuation">.</span>inRange<span class="token punctuation">(</span>hsv_img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lower_hsv<span class="token punctuation">,</span>upper_hsv<span class="token punctuation">)</span>
    masked_hsv_image <span class="token operator">=</span> apply_bright_mask<span class="token punctuation">(</span>mask<span class="token punctuation">,</span>rgb_image<span class="token punctuation">)</span>
    resized_masked_img <span class="token operator">=</span> apply_resize<span class="token punctuation">(</span>masked_hsv_image<span class="token punctuation">)</span>
    <span class="token comment">#show_img_bright(rgb_image,hsv_img,mask,resized_masked_img)</span>
    feature <span class="token operator">=</span> calculate_brightness<span class="token punctuation">(</span>resized_masked_img<span class="token punctuation">)</span>
    
    <span class="token comment">#print(feature)</span>
    <span class="token keyword">return</span> feature

</code></pre><p><img src="/udacity-self-driving-car-notes/assets/img/15221659953306.8d997a45.jpg" alt><img src="/udacity-self-driving-car-notes/assets/img/15221660448325.de4a4f11.jpg" alt></p><p><img src="/udacity-self-driving-car-notes/assets/img/15221660606569.762befa1.jpg" alt></p><p>至此，我们得到了图像的亮度特征。</p><p>但是作为交通灯，显然有亮度是不行的，因此我们再加入一个颜色特征</p><h3 id="_2-颜色特征"><a href="#_2-颜色特征" aria-hidden="true" class="header-anchor">#</a> 2. 颜色特征</h3><p>既然是信号灯，颜色自然是一个明显的特征，这里的思路是，首先转换为 hsv颜色空间，然后基于不同颜色对图像做 mask，将三种颜色对应的部分扣出来，分别计算其像素的和，最大的就是对应颜色</p><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">show_img</span><span class="token punctuation">(</span>rgb<span class="token punctuation">,</span>hsv<span class="token punctuation">,</span>mask<span class="token punctuation">,</span>masked<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fig<span class="token punctuation">,</span><span class="token punctuation">(</span>ax1<span class="token punctuation">,</span>ax2<span class="token punctuation">,</span>ax3<span class="token punctuation">,</span>ax4<span class="token punctuation">)</span> <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ax1<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>rgb<span class="token punctuation">)</span>
    ax2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>hsv<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>cmap<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span>
    ax3<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>mask<span class="token punctuation">)</span>
    ax4<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>masked<span class="token punctuation">)</span>
    
    
<span class="token keyword">def</span> <span class="token function">apply_mask</span><span class="token punctuation">(</span>mask<span class="token punctuation">,</span>rgb_image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    masked_hsv_image <span class="token operator">=</span> np<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>rgb_image<span class="token punctuation">)</span>
    masked_hsv_image<span class="token punctuation">[</span>mask <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> masked_hsv_image


<span class="token keyword">def</span> <span class="token function">get_sum_red</span><span class="token punctuation">(</span>rgb_image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    hsv <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>rgb_image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_RGB2HSV<span class="token punctuation">)</span>
    lower_hsv <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
    upper_hsv <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    mask<span class="token operator">=</span>cv2<span class="token punctuation">.</span>inRange<span class="token punctuation">(</span>hsv<span class="token punctuation">,</span>lower_hsv<span class="token punctuation">,</span>upper_hsv<span class="token punctuation">)</span>
    masked_hsv_image<span class="token operator">=</span>apply_mask<span class="token punctuation">(</span>mask<span class="token punctuation">,</span>rgb_image<span class="token punctuation">)</span>
    total <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>masked_hsv_image<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">#show_img(rgb_image,hsv,mask,masked_hsv_image)</span>
    
    <span class="token keyword">return</span> total

<span class="token keyword">def</span> <span class="token function">get_sum_yellow</span><span class="token punctuation">(</span>rgb_image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    hsv <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>rgb_image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_RGB2HSV<span class="token punctuation">)</span>
    lower_hsv <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
    upper_hsv <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    mask<span class="token operator">=</span>cv2<span class="token punctuation">.</span>inRange<span class="token punctuation">(</span>hsv<span class="token punctuation">,</span>lower_hsv<span class="token punctuation">,</span>upper_hsv<span class="token punctuation">)</span>
    masked_hsv_image<span class="token operator">=</span>apply_mask<span class="token punctuation">(</span>mask<span class="token punctuation">,</span>rgb_image<span class="token punctuation">)</span>
    total <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>masked_hsv_image<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">#show_img(rgb_image,hsv,mask,masked_hsv_image)</span>
    
    <span class="token keyword">return</span> total


<span class="token keyword">def</span> <span class="token function">get_sum_green</span><span class="token punctuation">(</span>rgb_image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    hsv <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>rgb_image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_RGB2HSV<span class="token punctuation">)</span>
    lower_hsv <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
    upper_hsv <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    mask<span class="token operator">=</span>cv2<span class="token punctuation">.</span>inRange<span class="token punctuation">(</span>hsv<span class="token punctuation">,</span>lower_hsv<span class="token punctuation">,</span>upper_hsv<span class="token punctuation">)</span>
    masked_hsv_image<span class="token operator">=</span>apply_mask<span class="token punctuation">(</span>mask<span class="token punctuation">,</span>rgb_image<span class="token punctuation">)</span>
    total <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>masked_hsv_image<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">#show_img(rgb_image,hsv,mask,masked_hsv_image)</span>
    
    <span class="token keyword">return</span> total



<span class="token comment"># (Optional) Add more image analysis and create more features</span>
<span class="token keyword">def</span> <span class="token function">create_feature_color</span><span class="token punctuation">(</span>rgb_image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    red_total <span class="token operator">=</span> get_sum_red<span class="token punctuation">(</span>rgb_image<span class="token punctuation">)</span>
    yellow_total <span class="token operator">=</span> get_sum_yellow<span class="token punctuation">(</span>rgb_image<span class="token punctuation">)</span>
    green_total <span class="token operator">=</span> get_sum_green<span class="token punctuation">(</span>rgb_image<span class="token punctuation">)</span>
    feature<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">[</span>red_total<span class="token punctuation">,</span>yellow_total<span class="token punctuation">,</span>green_total<span class="token punctuation">]</span>
    
</code></pre><p>查看一下利用hsv 三个分量阈值过滤的效果
<img src="/udacity-self-driving-car-notes/assets/img/15219722753416.f749bb98.jpg" alt><img src="/udacity-self-driving-car-notes/assets/img/15219723000936.97e3b3f7.jpg" alt><img src="/udacity-self-driving-car-notes/assets/img/15219723200489.5e4f2f72.jpg" alt></p><p>如果是用黄色过滤
<img src="/udacity-self-driving-car-notes/assets/img/15219724755519.27727e6d.jpg" alt>
用绿色过滤
<img src="/udacity-self-driving-car-notes/assets/img/15219725805911.6deee9e3.jpg" alt></p><h2 id="_4-图像分类并查看错误的情况"><a href="#_4-图像分类并查看错误的情况" aria-hidden="true" class="header-anchor">#</a> 4. 图像分类并查看错误的情况</h2><h3 id="_1-应用特征进行估计"><a href="#_1-应用特征进行估计" aria-hidden="true" class="header-anchor">#</a> 1. 应用特征进行估计</h3><p>这里要注意的是如何运用多个特征进行估计。</p><blockquote><p>Fully-connected layer
A fully-connected layer's job is to connect the input it sees to a desired form of output. As an example, say we are sorting images into two classes: day and night, you could give a fully-connected layer a set of feature maps and tell it to use a combination of these features (multiplying them, adding them, combining them, etc.) to output a prediction: whether a given image is likely taken during the &quot;day&quot; or &quot;night.&quot; This output prediction is sometimes called the output layer.</p></blockquote><p><img src="/udacity-self-driving-car-notes/assets/img/15221665702654.b7a052ce.jpg" alt></p><p>我们可以认为我们已经使用了两种不同的方法（convolutional layer）得到了两个特征，现在需要再 fully connected layer 将不同的特征进行组合。</p><p><strong>注意</strong>：特征指的是特征提取的原始结果，并非基于其得出的 one-hot 编码。</p><p>在这个项目里，我采取的是将两种特征（颜色和亮度）进行求和，然后使用合成后的特征进行预测，得到 one-hot 编码</p><pre class="language-python"><code>
<span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">:</span>
    predicted_label <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> feature<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> feature<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">and</span> feature<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> feature<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        predicted_label <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">elif</span> feature<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> feature<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">and</span> feature<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> feature<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        predicted_label <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">elif</span> feature<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> feature<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">and</span> feature<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> feature<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    
        predicted_label <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span> 
    <span class="token keyword">return</span> predicted_label
        

    
<span class="token keyword">def</span> <span class="token function">estimate_label</span><span class="token punctuation">(</span>rgb_image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    predicted_label <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
   
    <span class="token comment">#颜色特征 </span>
    color_feature <span class="token operator">=</span> create_feature_color<span class="token punctuation">(</span>rgb_image<span class="token punctuation">)</span>  
    <span class="token comment">#亮度特征</span>
    bright_feature <span class="token operator">=</span> create_feature_brightness<span class="token punctuation">(</span>rgb_image<span class="token punctuation">)</span>  
    <span class="token comment">#print(color_feature,&quot; &quot;,bright_feature)</span>
    
    <span class="token comment">#求和特征</span>
    feature <span class="token operator">=</span> <span class="token punctuation">[</span>i<span class="token operator">+</span>j <span class="token keyword">for</span> i<span class="token punctuation">,</span>j <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>color_feature<span class="token punctuation">,</span>bright_feature<span class="token punctuation">)</span><span class="token punctuation">]</span>
    
    predicted_label <span class="token operator">=</span> predict<span class="token punctuation">(</span>feature<span class="token punctuation">)</span>
        
    <span class="token keyword">return</span> predicted_label
</code></pre><h3 id="_2-图像分类并计算失误率"><a href="#_2-图像分类并计算失误率" aria-hidden="true" class="header-anchor">#</a> 2. 图像分类并计算失误率</h3><p>使用模型进行分类并收集错误的结果用于评估</p><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_misclassified_images</span><span class="token punctuation">(</span>test_images<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;对图像集进行分类并获取被错误分类的图像&quot;</span>
    misclassified_images_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> image <span class="token keyword">in</span> test_images<span class="token punctuation">:</span>
        im <span class="token operator">=</span> image<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        true_label <span class="token operator">=</span> image<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

        predicted_label <span class="token operator">=</span> estimate_label<span class="token punctuation">(</span>im<span class="token punctuation">)</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span>predicted_label <span class="token operator">!=</span> true_label<span class="token punctuation">)</span><span class="token punctuation">:</span>
            misclassified_images_labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>im<span class="token punctuation">,</span> predicted_label<span class="token punctuation">,</span> true_label<span class="token punctuation">)</span><span class="token punctuation">)</span>
            
    <span class="token keyword">return</span> misclassified_images_labels
    
</code></pre><pre class="language-python"><code><span class="token comment">#原始图像集</span>
TEST_IMAGE_LIST <span class="token operator">=</span> helpers<span class="token punctuation">.</span>load_dataset<span class="token punctuation">(</span>IMAGE_DIR_TEST<span class="token punctuation">)</span>
<span class="token comment">#标准化尺寸图像集</span>
STANDARDIZED_TEST_LIST <span class="token operator">=</span> standardize<span class="token punctuation">(</span>TEST_IMAGE_LIST<span class="token punctuation">)</span>
<span class="token comment">#错误分类的图像集</span>
MISCLASSIFIED <span class="token operator">=</span> get_misclassified_images<span class="token punctuation">(</span>STANDARDIZED_TEST_LIST<span class="token punctuation">)</span>


total <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>STANDARDIZED_TEST_LIST<span class="token punctuation">)</span>
num_correct <span class="token operator">=</span> total <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>MISCLASSIFIED<span class="token punctuation">)</span>
accuracy <span class="token operator">=</span> num_correct<span class="token operator">/</span>total

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Accuracy: '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>accuracy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Number of misclassified images = &quot;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>MISCLASSIFIED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">' out of '</span><span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>结果如下：</p><blockquote><p>Accuracy: 0.9831649831649831
Number of misclassified images = 5 out of 297</p></blockquote><p>使用两个特征的分类结果，可能优于一个特征，但也可能因为不当的组合产生劣化的效果。[^2]</p><h3 id="_3-查看错误分类的图像"><a href="#_3-查看错误分类的图像" aria-hidden="true" class="header-anchor">#</a> 3. 查看错误分类的图像</h3><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_label_string</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> label<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;red&quot;</span>
    <span class="token keyword">elif</span> label<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;yellow&quot;</span>
    <span class="token keyword">elif</span> label<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;green&quot;</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;miss&quot;</span>
        

img_num <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>MISCLASSIFIED<span class="token punctuation">)</span>
cols <span class="token operator">=</span> <span class="token number">4</span>
rows <span class="token operator">=</span> img_num<span class="token operator">%</span>cols
fig<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>nrows<span class="token operator">=</span>rows<span class="token punctuation">,</span> ncols<span class="token operator">=</span>cols<span class="token punctuation">,</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">#绘制子图， subplots 返回的axes 是一个 nrows*ncols 的矩阵</span>

fig<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>nrows<span class="token operator">=</span>img_num<span class="token punctuation">,</span> ncols<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">#给每一个子轴赋值</span>
<span class="token comment">#如果 axes 不是向量而是矩阵，则必须迭代axes.flat)</span>
<span class="token keyword">for</span> data<span class="token punctuation">,</span>axe <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>MISCLASSIFIED<span class="token punctuation">,</span>axes<span class="token punctuation">.</span>flat<span class="token punctuation">)</span><span class="token punctuation">:</span>
    img<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    label<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    true_label <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    axe<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    predict_label <span class="token operator">=</span> get_label_string<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
    true_label <span class="token operator">=</span> get_label_string<span class="token punctuation">(</span>true_label<span class="token punctuation">)</span>
    
    axe<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span>predict_label<span class="token operator">+</span><span class="token string">&quot; &lt;---&gt; &quot;</span><span class="token operator">+</span>true_label<span class="token punctuation">)</span>
    
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre><p>被错误分类的4幅图像如下[^3]</p><p><img src="/udacity-self-driving-car-notes/assets/img/15221671430297.5af930df.jpg" alt></p><hr><div class="tip custom-block"><p class="custom-block-title">扩展阅读</p><ol><li><a href="https://selfdrivingcars.mit.edu/" target="_blank" rel="noopener noreferrer">MIT 无人车课程</a></li><li><a href="https://pymotw.com/2/glob/" target="_blank" rel="noopener noreferrer">glob – Filename pattern matching</a></li><li><a href="https://matplotlib.org/api/pyplot_api.html#module-matplotlib.pyplot" target="_blank" rel="noopener noreferrer">matplotlib.pyplot</a></li><li><a href="https://machinelearningmastery.com/how-to-one-hot-encode-sequence-data-in-python/" target="_blank" rel="noopener noreferrer">one-hot label</a></li></ol></div></div><div class="content edit-link"><a href="https://github.com/hanxiaomax/udacity-self-driving-car-notes/edit/master/package/posts/intro-self-driving-car/isdc-traffic-light-classfier.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/isdc-router-planner.html" class="prev">
          路径规划器的实现
        </a></span><!----></p></div></div></div></div>
    <script src="/udacity-self-driving-car-notes/assets/js/23.20d37bd2.js" defer></script><script src="/udacity-self-driving-car-notes/assets/js/app.f862d195.js" defer></script>
  </body>
</html>
