<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>智能驾驶学习笔记 | 卷积神经网络</title>
    <meta name="description" content="by Lingfeng Ai">
    <link rel="icon" href="/udacity-self-driving-car-notes/logo.png">
  <link rel="manifest" href="/udacity-self-driving-car-notes/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/udacity-self-driving-car-notes/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/udacity-self-driving-car-notes/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/udacity-self-driving-car-notes/assets/css/39.styles.324ff695.css" as="style"><link rel="preload" href="/udacity-self-driving-car-notes/assets/js/app.f0029fc6.js" as="script"><link rel="preload" href="/udacity-self-driving-car-notes/assets/js/14.214ecf56.js" as="script"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/0.c09a41e5.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/1.44fdd069.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/2.a775a9b9.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/3.46ef3ea8.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/4.6539292a.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/5.c3b971c4.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/6.a764889e.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/7.ebb3565b.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/8.db44090d.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/9.a1b7e960.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/10.e1303d2e.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/11.8ca08bba.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/12.64526326.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/13.a2ba6b10.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/15.04e68051.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/16.05634d92.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/17.c68418aa.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/18.198d027b.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/19.cbd0e516.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/20.ff1ca196.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/21.3e809f59.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/22.dabc3e2f.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/23.326234d7.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/24.4b8ef11b.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/25.b3001cd9.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/26.4fe09e74.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/27.55448bc7.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/28.be240f99.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/29.21614022.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/30.f5741409.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/31.466a81e1.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/32.ef09f9cf.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/33.b63b80f3.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/34.b0b031a9.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/35.ba365681.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/36.5e6181c6.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/37.9c521dde.js"><link rel="prefetch" href="/udacity-self-driving-car-notes/assets/js/38.97529aa0.js">
    <link rel="stylesheet" href="/udacity-self-driving-car-notes/assets/css/39.styles.324ff695.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/udacity-self-driving-car-notes/" class="home-link router-link-active"><!----><span class="site-name">
      智能驾驶学习笔记
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/udacity-self-driving-car-notes/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">笔记</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/" class="nav-link">无人驾驶入门</a></li><li class="dropdown-item"><!----><a href="/udacity-self-driving-car-notes/posts/self-driving-car/" class="nav-link router-link-active">无人驾驶工程师</a></li><li class="dropdown-item"><!----><a href="/udacity-self-driving-car-notes/posts/others/" class="nav-link">未归类</a></li></ul></div></div><div class="nav-item"><a href="/udacity-self-driving-car-notes/res/" class="nav-link">资源</a></div><div class="nav-item"><a href="/udacity-self-driving-car-notes/contact/" class="nav-link">联系</a></div><a href="https://github.com/hanxiaomax/udacity-self-driving-car-notes/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/udacity-self-driving-car-notes/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">笔记</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/udacity-self-driving-car-notes/posts/intro-self-driving-car/" class="nav-link">无人驾驶入门</a></li><li class="dropdown-item"><!----><a href="/udacity-self-driving-car-notes/posts/self-driving-car/" class="nav-link router-link-active">无人驾驶工程师</a></li><li class="dropdown-item"><!----><a href="/udacity-self-driving-car-notes/posts/others/" class="nav-link">未归类</a></li></ul></div></div><div class="nav-item"><a href="/udacity-self-driving-car-notes/res/" class="nav-link">资源</a></div><div class="nav-item"><a href="/udacity-self-driving-car-notes/contact/" class="nav-link">联系</a></div><a href="https://github.com/hanxiaomax/udacity-self-driving-car-notes/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>1. 计算机视觉基础</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>2. 计算机视觉进阶</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>3. 深度学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>4. tersorflow</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>5. 卷积神经网络</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html" class="active sidebar-link">卷积神经网络</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#_1-统计不变量与贡献权重" class="sidebar-link">1. 统计不变量与贡献权重</a></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#_2-卷积神经网络" class="sidebar-link">2. 卷积神经网络</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#_1-术语" class="sidebar-link">1. 术语</a></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#_2-过滤器（kernel）" class="sidebar-link">2. 过滤器（kernel）</a></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#_3-feature-map-sizes" class="sidebar-link">3. Feature Map Sizes</a></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#_4-padding" class="sidebar-link">4. Padding</a></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#_5-卷积层尺寸" class="sidebar-link">5. 卷积层尺寸</a></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#_6-卷积神经网络的可视化" class="sidebar-link">6. 卷积神经网络的可视化</a></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#_4-池化" class="sidebar-link">4. 池化</a></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#_5-1x1卷积" class="sidebar-link">5. 1x1卷积</a></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#_6-inception-模块" class="sidebar-link">6. inception 模块</a></li></ul></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#_3-使用tensorflow构建cnn" class="sidebar-link">3. 使用Tensorflow构建CNN</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#例程" class="sidebar-link">例程</a></li></ul></li><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#_4-实现lenet" class="sidebar-link">4. 实现LeNet</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/cnn.html#预处理" class="sidebar-link">预处理</a></li></ul></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>6. 基于LeNet的信号灯分类</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>7. Keras</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>8. 迁移学习</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>9. 卡尔曼滤波</span><span class="arrow right"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h1 id="卷积神经网络"><a href="#卷积神经网络" aria-hidden="true" class="header-anchor">#</a> 卷积神经网络</h1><ul><li>如果我们已经知晓数据集的某些特征，学习可以变得更容易，例如，如果我们知道，颜色不是决定字母的因素，我们则可以采取灰度图像而非RGB图像</li><li>如果我们想判断图片中是否有猫，不指定猫的位置会让学习更简单</li><li>如果我们的神经网络试图理解一个句子，句子中反复出现的单词kitten，基本上和它出现的位置无关</li></ul><h2 id="_1-统计不变量与贡献权重"><a href="#_1-统计不变量与贡献权重" aria-hidden="true" class="header-anchor">#</a> 1. 统计不变量与贡献权重</h2><p>在上面两个例子中，目标中有部分信息可以反复利用，而不需要重新学习。我们可以通过<strong>共享权重</strong>来利用这一点。
<img src="/udacity-self-driving-car-notes/assets/img/15380921039335.5e0e19cc.jpg" alt></p><p>当我们知道，两个输入中可能包含相同的信息时，我们可以共享它们的权重，并且利用这些输入，共同训练权重。
<strong>统计不变量</strong>指的是基本上不会随时空变换的统计量。</p><h2 id="_2-卷积神经网络"><a href="#_2-卷积神经网络" aria-hidden="true" class="header-anchor">#</a> 2. 卷积神经网络</h2><h3 id="_1-术语"><a href="#_1-术语" aria-hidden="true" class="header-anchor">#</a> 1. 术语</h3><ul><li>过滤器</li><li>步长</li><li>patch</li><li>Padding</li></ul><h3 id="_2-过滤器（kernel）"><a href="#_2-过滤器（kernel）" aria-hidden="true" class="header-anchor">#</a> 2. 过滤器（kernel）</h3><p><img src="/udacity-self-driving-car-notes/assets/img/15381402524801.bb2ad1c1.jpg" alt></p><p>过滤器的深度是指过滤器的个数，每个过滤器提取特定的特征，那么特征的数量就是深度，假设深度为k，则该patch在下一层连接k个感知元。</p><p>为什么要连接多个感知元呢？因为一个patch可能有多个我们感兴趣的特征。</p><h3 id="_3-feature-map-sizes"><a href="#_3-feature-map-sizes" aria-hidden="true" class="header-anchor">#</a> 3. Feature Map Sizes</h3><p><img src="/udacity-self-driving-car-notes/assets/img/15381422049236.12e7ad51.jpg" alt><img src="/udacity-self-driving-car-notes/assets/img/15381422748914.83da37f6.jpg" alt></p><h3 id="_4-padding"><a href="#_4-padding" aria-hidden="true" class="header-anchor">#</a> 4. Padding</h3><p><img src="/udacity-self-driving-car-notes/assets/img/15381427269230.76c33031.jpg" alt></p><p><code>5*5</code>的grid中，创建一个<code>3*3</code>的kernel，步长为1 的情况下，则下一层的维度是<code>3*3</code>（在任意方向只能通过移动，创建3个patch）</p><p>为了不减少维度，我们可以对grid进行补0操作，使的我们能够创建足够多的patch来保持维度不变
<img src="/udacity-self-driving-car-notes/assets/img/15381430330924.955207e0.jpg" alt></p><h3 id="_5-卷积层尺寸"><a href="#_5-卷积层尺寸" aria-hidden="true" class="header-anchor">#</a> 5. 卷积层尺寸</h3><p>我们必须能够知道，每层网络的大小，以便知晓模型的规模，在尺寸和性能上做出取舍</p><ul><li>输入层 width 为 W ， height 为 H</li><li>卷积层的过滤器大小为 F</li><li>步长为 S</li><li>padding 为 P</li><li>深度，即过滤器的个数为 K</li></ul><p>则，下一层的尺寸为：</p><ul><li><code>W_out =[ (W−F+2P)/S] + 1</code></li><li><code>H_out = [(H-F+2P)/S] + 1</code></li><li><code>D_out = K</code></li><li>下一层的尺寸为 <code>W_out * H_out * D_out</code></li></ul><h4 id="练习"><a href="#练习" aria-hidden="true" class="header-anchor">#</a> 练习</h4><p>Setup
H = height, W = width, D = depth</p><ul><li>We have an input of shape 32x32x3 (HxWxD)</li><li>20 filters of shape 8x8x3 (HxWxD)</li><li>A stride of 2 for both the height and width (S)</li><li>With padding of size 1 (P)</li></ul><pre class="language-text"><code>D_out = K = 20
W_out =[ (32−8+2)/2] + 1 = 14
H_out =[ (32−8+2)/2] + 1 = 14
</code></pre><p>但是下面一段代码，conv的输出维度是<code>[1, 16, 16, 20]</code>，而不是<code>[1, 14, 14, 20]</code>，这和tf添加padding的机制有关，可以看<a href="https://www.tensorflow.org/api_guides/python/nn#Convolution" target="_blank" rel="noopener noreferrer">这里</a></p><pre class="language-python"><code><span class="token builtin">input</span> <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
filter_weights <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>truncated_normal<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># (height, width, input_depth, output_depth)</span>
filter_bias <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
strides <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment"># (batch, height, width, depth)</span>
padding <span class="token operator">=</span> <span class="token string">'SAME'</span>
conv <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> filter_weights<span class="token punctuation">,</span> strides<span class="token punctuation">,</span> padding<span class="token punctuation">)</span> <span class="token operator">+</span> filter_bias
</code></pre><p>简单来讲：
<strong>SAME</strong> Padding:
out_height = ceil(float(in_height) / float(strides[1]))
out_width = ceil(float(in_width) / float(strides[2]))
<strong>VALID</strong> Padding
out_height = ceil(float(in_height - filter_height + 1) / float(strides[1]))
out_width = ceil(float(in_width - filter_width + 1) / float(strides[2]))</p><h4 id="参数个数计算"><a href="#参数个数计算" aria-hidden="true" class="header-anchor">#</a> 参数个数计算</h4><p>按照上述的输入输出结果（Output Layer 14x14x20 (HxWxD)），计算参数的个数：</p><ul><li>如果不共享参数，则每一层参数个数为<code>(8 * 8 * 3 + 1) * (14 * 14 * 20) = 756560</code>（+1是bias）</li><li>如果是共享参数的CNN，则参数个数为<code>(8 * 8 * 3 + 1) * 20 = 3840 + 20 = 3860</code></li></ul><p>我们可以看出，共享参数则不需要在输出层的每个W*H上再去学习，只需要乘上深度即可。</p><h3 id="_6-卷积神经网络的可视化"><a href="#_6-卷积神经网络的可视化" aria-hidden="true" class="header-anchor">#</a> 6. 卷积神经网络的可视化</h3><div class="tip custom-block"><p class="custom-block-title">文献</p><p><a href="http://www.matthewzeiler.com/wp-content/uploads/2017/07/eccv2014.pdf" target="_blank" rel="noopener noreferrer">LNCS 8689 - Visualizing and Understanding Convolutional Networks</a></p></div><h4 id="第一层"><a href="#第一层" aria-hidden="true" class="header-anchor">#</a> 第一层</h4><p><img src="/udacity-self-driving-car-notes/assets/img/15381451572296.66e98552.jpg" alt></p><p>So, the first layer of our CNN clearly picks out very simple shapes and patterns like lines and blobs.</p><h4 id="第二层"><a href="#第二层" aria-hidden="true" class="header-anchor">#</a> 第二层</h4><p><img src="/udacity-self-driving-car-notes/assets/img/15381463702675.ec33f8a9.jpg" alt></p><p>As you see in the image above, the second layer of the CNN recognizes circles (second row, second column), stripes (first row, second column), and rectangles (bottom right).</p><h4 id="第三层"><a href="#第三层" aria-hidden="true" class="header-anchor">#</a> 第三层</h4><p><img src="/udacity-self-driving-car-notes/assets/img/15381465295268.77134430.jpg" alt></p><p>The third layer picks out complex combinations of features from the second layer. These include things like grids, and honeycombs (top left), wheels (second row, second column), and even faces (third row, third column).</p><h4 id="第五层"><a href="#第五层" aria-hidden="true" class="header-anchor">#</a> 第五层</h4><p><img src="/udacity-self-driving-car-notes/assets/img/15381474001238.b8a7f9a6.jpg" alt></p><h3 id="_4-池化"><a href="#_4-池化" aria-hidden="true" class="header-anchor">#</a> 4. 池化</h3><p>通过调整步长，我们可以降低图像的采样率，即移除一些图像信息，此外我们还可以将相邻的卷积进行聚合，得到一个卷积值来降低采样率，这个过程叫做<strong>池化</strong>。池化用来减少输出尺寸，避免过拟合。</p><ul><li>最大池化</li><li>平均池化</li></ul><h4 id="最大池化的特点："><a href="#最大池化的特点：" aria-hidden="true" class="header-anchor">#</a> 最大池化的特点：</h4><ul><li>不会增加参数，不必担心过拟合</li><li>通常会提高模型准确率</li><li>计算量更大，因为步长小了</li><li>超参数增加：池区大小、池化步幅</li></ul><p>将池区中的卷积去最大值保留
<img src="/udacity-self-driving-car-notes/assets/img/15383590668383.9bdf08ad.jpg" alt></p><pre class="language-python"><code>conv_layer <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> weight<span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">)</span>
conv_layer <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>bias_add<span class="token punctuation">(</span>conv_layer<span class="token punctuation">,</span> bias<span class="token punctuation">)</span>
conv_layer <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>conv_layer<span class="token punctuation">)</span>
<span class="token comment"># Apply Max Pooling</span>
conv_layer <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>max_pool<span class="token punctuation">(</span>
    conv_layer<span class="token punctuation">,</span>
    ksize<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">)</span>
</code></pre><p>The ksize and strides parameters are structured as 4-element lists, with each element corresponding to a dimension of the input tensor ([batch, height, width, channels]). For both ksize and strides, the batch and channel dimensions are typically set to 1.</p><h4 id="典型的cnn结构"><a href="#典型的cnn结构" aria-hidden="true" class="header-anchor">#</a> 典型的CNN结构</h4><p><img src="/udacity-self-driving-car-notes/assets/img/15383589937717.250065dc.jpg" alt></p><h4 id="池化层的输出"><a href="#池化层的输出" aria-hidden="true" class="header-anchor">#</a> 池化层的输出</h4><p>池化层不改变输出的深度，它单独应用到每一个深度切片上。</p><p>假定：H = height, W = width, D = depth</p><ul><li>We have an input of shape 4x4x5 (HxWxD)</li><li>Filter of shape 2x2 (HxW)</li><li>A stride of 2 for both the height and width (S)</li></ul><p><img src="/udacity-self-driving-car-notes/assets/img/15383596251413.ad24e96e.jpg" alt></p><pre class="language-text"><code>new_height = (input_height - filter_height)/S + 1
new_width = (input_width - filter_width)/S + 1
</code></pre><p>输出层的尺寸为2x2x5</p><pre class="language-python"><code><span class="token builtin">input</span> <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
filter_shape <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
strides <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
padding <span class="token operator">=</span> <span class="token string">'VALID'</span>
pool <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>max_pool<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> filter_shape<span class="token punctuation">,</span> strides<span class="token punctuation">,</span> padding<span class="token punctuation">)</span>
</code></pre><p>输出结果为  [1, 2, 2, 5], 即使padding方式修改为： 'SAME'</p><h3 id="_5-1x1卷积"><a href="#_5-1x1卷积" aria-hidden="true" class="header-anchor">#</a> 5. 1x1卷积</h3><p><img src="/udacity-self-driving-car-notes/assets/img/15383601524457.e49095d2.jpg" alt></p><p>1x1卷积可以增加输出的深度，且运算非常简单</p><h3 id="_6-inception-模块"><a href="#_6-inception-模块" aria-hidden="true" class="header-anchor">#</a> 6. inception 模块</h3><p><img src="/udacity-self-driving-car-notes/assets/img/15383604396008.3cdd8d81.jpg" alt></p><h2 id="_3-使用tensorflow构建cnn"><a href="#_3-使用tensorflow构建cnn" aria-hidden="true" class="header-anchor">#</a> 3. 使用Tensorflow构建CNN</h2><p>TensorFlow 提供了 <code>tf.nn.conv2d()</code>和<code>tf.nn.bias_add()</code> 两个函数来构建CNN</p><pre class="language-python"><code><span class="token comment"># Output depth</span>
k_output <span class="token operator">=</span> <span class="token number">64</span>

<span class="token comment"># Image Properties</span>
image_width <span class="token operator">=</span> <span class="token number">10</span>
image_height <span class="token operator">=</span> <span class="token number">10</span>
color_channels <span class="token operator">=</span> <span class="token number">3</span>

<span class="token comment"># Convolution filter</span>
filter_size_width <span class="token operator">=</span> <span class="token number">5</span>
filter_size_height <span class="token operator">=</span> <span class="token number">5</span>

<span class="token comment"># Input/Image</span>
<span class="token builtin">input</span> <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>
    tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span>
    shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> image_height<span class="token punctuation">,</span> image_width<span class="token punctuation">,</span> color_channels<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># Weight and bias</span>
weight <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>truncated_normal<span class="token punctuation">(</span>
    <span class="token punctuation">[</span>filter_size_height<span class="token punctuation">,</span> filter_size_width<span class="token punctuation">,</span> color_channels<span class="token punctuation">,</span> k_output<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
bias <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>k_output<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Apply Convolution</span>
conv_layer <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> weight<span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">)</span>
<span class="token comment"># Add bias</span>
conv_layer <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>bias_add<span class="token punctuation">(</span>conv_layer<span class="token punctuation">,</span> bias<span class="token punctuation">)</span>
<span class="token comment"># Apply activation function</span>
conv_layer <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>conv_layer<span class="token punctuation">)</span>
</code></pre><p>使用 <code>tf.nn.conv2d()</code> 来构建一个卷积层，步长是**<code>[1, 2, 2, 1]</code><strong>，分别对应</strong><code>[batch, input_height, input_width, input_channels]</code>**， 其中，batch和input_channels我们一般就设置为1。</p><h3 id="例程"><a href="#例程" aria-hidden="true" class="header-anchor">#</a> 例程</h3><pre class="language-python"><code><span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>examples<span class="token punctuation">.</span>tutorials<span class="token punctuation">.</span>mnist <span class="token keyword">import</span> input_data
mnist <span class="token operator">=</span> input_data<span class="token punctuation">.</span>read_data_sets<span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> one_hot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> reshape<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf

<span class="token comment"># Parameters</span>
learning_rate <span class="token operator">=</span> <span class="token number">0.00001</span>
epochs <span class="token operator">=</span> <span class="token number">10</span>
batch_size <span class="token operator">=</span> <span class="token number">128</span>

<span class="token comment"># Number of samples to calculate validation and accuracy</span>
<span class="token comment"># Decrease this if you're running out of memory to calculate accuracy</span>
test_valid_size <span class="token operator">=</span> <span class="token number">256</span>

<span class="token comment"># Network Parameters</span>
n_classes <span class="token operator">=</span> <span class="token number">10</span>  <span class="token comment"># MNIST total classes (0-9 digits)</span>
dropout <span class="token operator">=</span> <span class="token number">0.75</span>  <span class="token comment"># Dropout, probability to keep units</span>
</code></pre><pre class="language-python"><code><span class="token comment"># Store layers weight &amp; bias</span>
weights <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'wc1'</span><span class="token punctuation">:</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'wc2'</span><span class="token punctuation">:</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'wd1'</span><span class="token punctuation">:</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'out'</span><span class="token punctuation">:</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> n_classes<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

biases <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'bc1'</span><span class="token punctuation">:</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'bc2'</span><span class="token punctuation">:</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'bd1'</span><span class="token punctuation">:</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'out'</span><span class="token punctuation">:</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span><span class="token punctuation">[</span>n_classes<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre><h4 id="卷积"><a href="#卷积" aria-hidden="true" class="header-anchor">#</a><a href="https://en.wikipedia.org/wiki/Convolution" target="_blank" rel="noopener noreferrer">卷积</a></h4><p><img src="http://deeplearning.stanford.edu/wiki/images/6/6c/Convolution_schematic.gif" alt></p><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">conv2d</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Filter (weights and bias)</span>
    F_W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>truncated_normal<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    F_b <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    strides <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    padding <span class="token operator">=</span> <span class="token string">'VALID'</span>
    <span class="token keyword">return</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span> F_W<span class="token punctuation">,</span> strides<span class="token punctuation">,</span> padding<span class="token punctuation">)</span> <span class="token operator">+</span> F_b
</code></pre><h4 id="最大池化"><a href="#最大池化" aria-hidden="true" class="header-anchor">#</a><a href="https://en.wikipedia.org/wiki/Convolutional_neural_network#Pooling_layer" target="_blank" rel="noopener noreferrer">最大池化</a></h4><p><img src="/udacity-self-driving-car-notes/assets/img/15383614215865.58bb314d.jpg" alt></p><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">maxpool2d</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>max_pool<span class="token punctuation">(</span>
        x<span class="token punctuation">,</span>
        ksize<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> k<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> k<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">)</span>
</code></pre><h4 id="模型结构"><a href="#模型结构" aria-hidden="true" class="header-anchor">#</a> 模型结构</h4><p><img src="/udacity-self-driving-car-notes/assets/img/15383615644699.00b6b893.jpg" alt></p><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">conv_net</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> biases<span class="token punctuation">,</span> dropout<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Layer 1 - 28*28*1 to 14*14*32</span>
    conv1 <span class="token operator">=</span> conv2d<span class="token punctuation">(</span>x<span class="token punctuation">,</span> weights<span class="token punctuation">[</span><span class="token string">'wc1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> biases<span class="token punctuation">[</span><span class="token string">'bc1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    conv1 <span class="token operator">=</span> maxpool2d<span class="token punctuation">(</span>conv1<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token comment"># Layer 2 - 14*14*32 to 7*7*64</span>
    conv2 <span class="token operator">=</span> conv2d<span class="token punctuation">(</span>conv1<span class="token punctuation">,</span> weights<span class="token punctuation">[</span><span class="token string">'wc2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> biases<span class="token punctuation">[</span><span class="token string">'bc2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    conv2 <span class="token operator">=</span> maxpool2d<span class="token punctuation">(</span>conv2<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token comment"># Fully connected layer - 7*7*64 to 1024</span>
    fc1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>conv2<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> weights<span class="token punctuation">[</span><span class="token string">'wd1'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get_shape<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as_list<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    fc1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>fc1<span class="token punctuation">,</span> weights<span class="token punctuation">[</span><span class="token string">'wd1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> biases<span class="token punctuation">[</span><span class="token string">'bd1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    fc1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>fc1<span class="token punctuation">)</span>
    fc1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>fc1<span class="token punctuation">,</span> dropout<span class="token punctuation">)</span>

    <span class="token comment"># Output Layer - class prediction - 1024 to 10</span>
    out <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>fc1<span class="token punctuation">,</span> weights<span class="token punctuation">[</span><span class="token string">'out'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> biases<span class="token punctuation">[</span><span class="token string">'out'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> out
</code></pre><h4 id="session"><a href="#session" aria-hidden="true" class="header-anchor">#</a> Session</h4><pre class="language-python"><code><span class="token comment"># tf Graph input</span>
x <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> n_classes<span class="token punctuation">]</span><span class="token punctuation">)</span>
keep_prob <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

<span class="token comment"># Model</span>
logits <span class="token operator">=</span> conv_net<span class="token punctuation">(</span>x<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> biases<span class="token punctuation">,</span> keep_prob<span class="token punctuation">)</span>

<span class="token comment"># Define loss and optimizer</span>
cost <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>\
    tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>softmax_cross_entropy_with_logits<span class="token punctuation">(</span>logits<span class="token operator">=</span>logits<span class="token punctuation">,</span> labels<span class="token operator">=</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>GradientDescentOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span>learning_rate<span class="token punctuation">)</span>\
    <span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>cost<span class="token punctuation">)</span>

<span class="token comment"># Accuracy</span>
correct_pred <span class="token operator">=</span> tf<span class="token punctuation">.</span>equal<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>y<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
accuracy <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>correct_pred<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Initializing the variables</span>
init <span class="token operator">=</span> tf<span class="token punctuation">.</span> global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Launch the graph</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>init<span class="token punctuation">)</span>

    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> batch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>mnist<span class="token punctuation">.</span>train<span class="token punctuation">.</span>num_examples<span class="token operator">//</span>batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
            batch_x<span class="token punctuation">,</span> batch_y <span class="token operator">=</span> mnist<span class="token punctuation">.</span>train<span class="token punctuation">.</span>next_batch<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span>
            sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{</span>
                x<span class="token punctuation">:</span> batch_x<span class="token punctuation">,</span>
                y<span class="token punctuation">:</span> batch_y<span class="token punctuation">,</span>
                keep_prob<span class="token punctuation">:</span> dropout<span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token comment"># Calculate batch loss and accuracy</span>
            loss <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>cost<span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{</span>
                x<span class="token punctuation">:</span> batch_x<span class="token punctuation">,</span>
                y<span class="token punctuation">:</span> batch_y<span class="token punctuation">,</span>
                keep_prob<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            valid_acc <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>accuracy<span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{</span>
                x<span class="token punctuation">:</span> mnist<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>images<span class="token punctuation">[</span><span class="token punctuation">:</span>test_valid_size<span class="token punctuation">]</span><span class="token punctuation">,</span>
                y<span class="token punctuation">:</span> mnist<span class="token punctuation">.</span>validation<span class="token punctuation">.</span>labels<span class="token punctuation">[</span><span class="token punctuation">:</span>test_valid_size<span class="token punctuation">]</span><span class="token punctuation">,</span>
                keep_prob<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Epoch {:&gt;2}, Batch {:&gt;3} -'</span>
                  <span class="token string">'Loss: {:&gt;10.4f} Validation Accuracy: {:.6f}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                batch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                loss<span class="token punctuation">,</span>
                valid_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Calculate Test Accuracy</span>
    test_acc <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>accuracy<span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{</span>
        x<span class="token punctuation">:</span> mnist<span class="token punctuation">.</span>test<span class="token punctuation">.</span>images<span class="token punctuation">[</span><span class="token punctuation">:</span>test_valid_size<span class="token punctuation">]</span><span class="token punctuation">,</span>
        y<span class="token punctuation">:</span> mnist<span class="token punctuation">.</span>test<span class="token punctuation">.</span>labels<span class="token punctuation">[</span><span class="token punctuation">:</span>test_valid_size<span class="token punctuation">]</span><span class="token punctuation">,</span>
        keep_prob<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Testing Accuracy: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>test_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><h2 id="_4-实现lenet"><a href="#_4-实现lenet" aria-hidden="true" class="header-anchor">#</a> 4. 实现LeNet</h2><h3 id="预处理"><a href="#预处理" aria-hidden="true" class="header-anchor">#</a> 预处理</h3><p>An MNIST image is initially 784 features (1D). If the data is not normalized from [0, 255] to [0, 1], normalize it. We reshape this to (28, 28, 1) (3D), and pad the image with 0s such that the height and width are 32 (centers digit further). Thus, the input shape going into the first convolutional layer is 32x32x1.</p><h4 id="网络模型规格"><a href="#网络模型规格" aria-hidden="true" class="header-anchor">#</a> 网络模型规格</h4><table><thead><tr><th style="text-align:center">分层</th><th style="text-align:center">输入</th><th style="text-align:center">输出</th><th style="text-align:center">备注</th></tr></thead><tbody><tr><td style="text-align:center">卷积层-1</td><td style="text-align:center">32x32x1</td><td style="text-align:center">28x28x6</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">激活层-1</td><td style="text-align:center">28x28x6</td><td style="text-align:center">激活函数</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">池化层-1</td><td style="text-align:center">28x28x6</td><td style="text-align:center">14x14x6</td><td style="text-align:center">使用kernel大小为2，步长为2进行池化</td></tr><tr><td style="text-align:center">卷积层-2</td><td style="text-align:center">14x14x6</td><td style="text-align:center">10x10x16</td><td style="text-align:center">使用fliter 5*5</td></tr><tr><td style="text-align:center">激活层-2</td><td style="text-align:center">10x10x16</td><td style="text-align:center">10x10x16</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">池化层-2</td><td style="text-align:center">10x10x16</td><td style="text-align:center">5x5x16</td><td style="text-align:center">使用kernel大小为2，步长为2进行池化</td></tr><tr><td style="text-align:center">扁平层</td><td style="text-align:center">5x5x16</td><td style="text-align:center">转换为1维数据: 400</td><td style="text-align:center"><code>tf.contrib.layers.flatten</code></td></tr><tr><td style="text-align:center">全连接层-1</td><td style="text-align:center">400</td><td style="text-align:center">120</td><td style="text-align:center"><code>tf.Variable(tf.truncated_normal(shape=(400, 120), mean = mu, stddev = sigma))</code></td></tr><tr><td style="text-align:center">激活层-3</td><td style="text-align:center">120</td><td style="text-align:center">120</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">全连接层-2</td><td style="text-align:center">120</td><td style="text-align:center">84</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">激活层-4</td><td style="text-align:center">84</td><td style="text-align:center">84</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">全连接层-3</td><td style="text-align:center">84</td><td style="text-align:center">10</td><td style="text-align:center"></td></tr></tbody></table><h4 id="pipeline"><a href="#pipeline" aria-hidden="true" class="header-anchor">#</a> pipeline</h4><pre class="language-python"><code>rate <span class="token operator">=</span> <span class="token number">0.001</span> <span class="token comment">#学习速率</span>

logits <span class="token operator">=</span> LeNet<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
cross_entropy <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>softmax_cross_entropy_with_logits<span class="token punctuation">(</span>labels<span class="token operator">=</span>one_hot_y<span class="token punctuation">,</span> logits<span class="token operator">=</span>logits<span class="token punctuation">)</span>
loss_operation <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>cross_entropy<span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>AdamOptimizer<span class="token punctuation">(</span>learning_rate <span class="token operator">=</span> rate<span class="token punctuation">)</span>
training_operation <span class="token operator">=</span> optimizer<span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss_operation<span class="token punctuation">)</span>
</code></pre><p>交叉熵函数：<code>tf.nn.softmax_cross_entropy_with_logits</code>
全局均值计算：<code>tf.reduce_mean(cross_entropy)</code>
优化函数：<code>tf.train.AdamOptimizer</code> 是改进的梯度下降法</p><div class="tip custom-block"><p class="custom-block-title">扩展阅读</p><ol><li><a href="https://ujjwalkarn.me/2016/08/11/intuitive-explanation-convnets/" target="_blank" rel="noopener noreferrer">An Intuitive Explanation of Convolutional Neural Networks</a></li><li><a href="https://en.wikipedia.org/wiki/Artificial_neuron" target="_blank" rel="noopener noreferrer">Artificial neuron</a></li><li><a href="http://deeplearning.stanford.edu/wiki/index.php/Feature_extraction_using_convolution" target="_blank" rel="noopener noreferrer">Feature extraction using convolution</a></li><li><a href="http://www.matthewzeiler.com/wp-content/uploads/2017/07/eccv2014.pdf" target="_blank" rel="noopener noreferrer">Visualizing and Understanding Convolutional Networks</a></li><li><a href="https://en.wikipedia.org/wiki/Convolutional_neural_network" target="_blank" rel="noopener noreferrer">wiki/Convolutional_neural_network</a></li><li><a href="https://www.deeplearningbook.org/" target="_blank" rel="noopener noreferrer">Deep Learning</a></li><li><a href="http://cs231n.github.io/" target="_blank" rel="noopener noreferrer">CS231n Convolutional Neural Networks for Visual Recognition</a></li></ol></div></div><div class="content edit-link"><a href="https://github.com/hanxiaomax/udacity-self-driving-car-notes/edit/master/package/posts/self-driving-car/cnn.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/udacity-self-driving-car-notes/posts/self-driving-car/deepnetwork.html" class="prev">
          深度神经网络
        </a></span><span class="next"><a href="/udacity-self-driving-car-notes/posts/self-driving-car/lenet.html">
          基于LeNet的信号灯分类
        </a> →
      </span></p></div></div></div></div>
    <script src="/udacity-self-driving-car-notes/assets/js/14.214ecf56.js" defer></script><script src="/udacity-self-driving-car-notes/assets/js/app.f0029fc6.js" defer></script>
  </body>
</html>
